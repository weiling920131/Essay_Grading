<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chatbot Interface</title>
  <style>
    /* CSS 样式 */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      display: flex;
    }

    /* 左侧黑色边栏样式 */
    .sidebar {
      width: 200px;
      background-color: #333;
      color: #fff;
      padding: 20px;
      box-sizing: border-box;
    }

    /* 绿色按钮样式 */
    .add-chat-btn {
      margin-bottom: 10px;
      padding: 10px 15px;
      background-color: #4CAF50;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      display: block;
    }

    /* 红色按钮样式 */
    .chat-btn {
      margin-bottom: 5px;
      padding: 5px 10px;
      background-color: #FF0000;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      display: block;
    }

    /* 右侧聊天窗口样式 */
    .chat-container {
      flex: 1;
      padding: 20px;
      background-color: #f4f4f4;
      overflow-y: scroll;
    }

    .chat-box {
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #fff;
      display: none; /* 默认隐藏所有聊天窗口 */
    }
  </style>
</head>
<body>
  <div class="sidebar" id="sidebar">
    <!-- 左侧黑色边栏内容 -->
    <button class="add-chat-btn" onclick="addChatWindow()">Add Chat Window</button>
  </div>

  <div class="chat-container" id="chatContainer">
    <!-- 右侧聊天窗口 -->
    <div id="chatGPT" class="chat-box" style="display: block;">
      <h2>Welcome to ChatGPT!</h2>
      <p>Select a conversation on the left.</p>
    </div>
    <!-- 这里将动态生成聊天窗口 -->
  </div>

  <script>
    const chatWindows = {}; // 用于存储已创建的聊天窗口

    function addChatWindow() {
      const chatContainer = document.getElementById('chatContainer');
      const sidebar = document.getElementById('sidebar');
      // 创建新的聊天窗口
      const chatWindowId = `chat-box-${Object.keys(chatWindows).length + 1}`;

      // 从后端获取ID
      fetch('http://localhost:8080/api/get-thread-id')
      .then(response => response.json())
      .then(data => {
        // 存储从后端获取的ID
        const threadID = data.threadID; // 假设后端返回的JSON包含threadID字段

        // debug
        console.log('Thread ID:', threadID);

        const newChatWindow = document.createElement('div');
        newChatWindow.classList.add('chat-box');
        newChatWindow.id = chatWindowId;
        newChatWindow.style.display = 'none'; // 默认隐藏新窗口
        newChatWindow.innerHTML = `<h2>Chat Window ${Object.keys(chatWindows).length + 1}</h2>
          <div id="chat-history-${Object.keys(chatWindows).length + 1}"></div>
          <input type="text" id="user-input-${Object.keys(chatWindows).length + 1}" placeholder="Type a message...">
          <input type="button" value="Send" onclick="sendMessage('${chatWindowId}', '${threadID}')">`;

        // 将新的聊天窗口添加到右侧聊天容器中
        chatContainer.appendChild(newChatWindow);

        // 创建对应的红色按钮
        const newChatButton = document.createElement('button');
        newChatButton.classList.add('chat-btn');
        newChatButton.textContent = `Window ${Object.keys(chatWindows).length + 1}`;
        sidebar.appendChild(newChatButton);

        // 为新按钮添加点击事件，用于显示对应的聊天窗口
        newChatButton.addEventListener('click', function() {
          toggleChatWindow(chatWindowId);
        });

        chatWindows[chatWindowId] = { windowId: chatWindowId, threadID: threadID };
        toggleChatWindow(chatWindowId);
      })
      .catch(error => {
        console.error('Error fetching the thread ID:', error);
      });
    }

    function toggleChatWindow(windowId) {
      const chatWindowsElements = document.querySelectorAll('.chat-box');
      chatWindowsElements.forEach(window => {
        window.style.display = 'none';
      });

      const selectedWindow = document.getElementById(windowId);
      selectedWindow.style.display = 'block';
    }

    function sendMessage(windowId, threadID) {
      const userInput = document.getElementById(`user-input-${windowId.split('-')[2]}`).value;
      const chatHistory = document.getElementById(`chat-history-${windowId.split('-')[2]}`);

      // 显示用户消息
      chatHistory.innerHTML += `<div style="text-align: right; color: #007bff;">You: ${userInput}</div>`;
      function isJsonString(str) {
          try {
              JSON.parse(str);
              return true;
          } catch (e) {
              return false;
          }
      }
      // 发送用户输入到后端
      fetch('http://localhost:8080/api/thread-messages', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            userInput: userInput, // 用户输入
            threadID: threadID    // 线程ID
          }) // 将用户输入和线程ID作为JSON发送
      })
      .then(response => {
          if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json(); // 解析JSON响应
      })
      .then(jsonResponse => {
          // 处理后端返回的数据
          // 例如，将响应显示在聊天历史中
          // chatHistory.innerHTML += `<div style="color: green;">Response: ${JSON.stringify(jsonResponse)}</div>`;
          const jsonString = JSON.stringify(jsonResponse);
          const parsedData = JSON.parse(jsonString);
          console.log(parsedData);
          chatHistory.innerHTML += `<div style="color: green;">Response: ${parsedData}</div>`;
          // chatHistory.innerHTML += `<div style="color: green;">Response: ${jsonString}</div>`;
          try{
            chatHistory.innerHTML += `<div style="color: black;">`;
            // chatHistory.innerHTML += `<h3>${parsedData["Grading"]["Content"]["Score"]} <h3>`;
            // chatHistory.innerHTML += `<h3>${parsedData["Content"]["Score"]} <h3>`;
              for(const [key, value] of Object.entries(jsonResponse)){
                chatHistory.innerHTML += `<h3>${value}</h3>`;
                if(key == "Content" || key == "Organization" || key == "Grammar and Sentence Structure" || key == "Vocabulary and Spelling"){
                  chatHistory.innerHTML += `
                      <h3>${key}: ${jsonString[key].Score}</h3>
                      <pre>Rewrite: ${jsonString[key].Rewrite}</pre>
                      <pre>Comments: ${jsonString[key].Comments}</pre>`;
              }
            }
            chatHistory.innerHTML += `</div>`;
          }catch(e){
            console.log(e);
            chatHistory.innerHTML += `<div style="color: red;">${jsonString}</div>`;
          }
          // try {
          //   console.log(jsonString);
          //   const parsedData = JSON.parse(jsonString);
          //   console.log(parsedData);

          //   // let formattedHtml = '<div style="color: green;">Response:<br>';

          //   // for (const section in parsedData) {
          //   //     formattedHtml += `<h3>${section}</h3>`;
          //   //     const sectionData = parsedData[section];
          //   //     for (const key in sectionData) {
          //   //         formattedHtml += `<p><strong>${key}:</strong> ${sectionData[key]}</p>`;
          //   //     }
          //   // }

          //   // formattedHtml += '</div>';

          //   // chatHistory.innerHTML += formattedHtml;   

          //   chatHistory.innerHTML += `<div style="color: green;"><pre>${JSON.stringify(parsedData, null, 2)}</pre></div>`;
            
          //   // Expected Respond Format
          //   if (isJsonString(jsonString)) {
          //     // Display the JSON response in the right column
          //     const totalScore = jsonResponse["Total Holistic Score"];
          //     const contentScore = jsonResponse.Ratings.Content.Score;
          //     const contentRewrite = "Rewrite: " + jsonResponse.Ratings.Content.Rewrite;
          //     const contentComments = "Comments: " + jsonResponse.Ratings.Content.Comments;
          //     const organizationScore = jsonResponse.Ratings.Organization.Score;
          //     const organizationRewrite = "Rewrite: " + jsonResponse.Ratings.Organization.Rewrite;
          //     const organizationComments = "Comments: " + jsonResponse.Ratings.Organization.Comments;
          //     const grammarScore = jsonResponse.Ratings["Grammar and Sentence Structure"].Score;
          //     const grammarRewrite = "Rewrite: " + jsonResponse.Ratings["Grammar and Sentence Structure"].Rewrite;
          //     const grammarComments = "Comments: " + jsonResponse.Ratings["Grammar and Sentence Structure"].Comments;
          //     const vocabularyScore = jsonResponse.Ratings["Vocabulary and Spelling"].Score;
          //     const vocabularyRewrite = "Rewrite: " + jsonResponse.Ratings["Vocabulary and Spelling"].Rewrite;
          //     const vocabularyComments = "Comments: " + jsonResponse.Ratings["Vocabulary and Spelling"].Comments;
          //     // 模拟聊天机器人回复（替换为实际响应）
          //     const botResponse = "This is a bot response. Replace it with the actual response.";
          //     chatHistory.innerHTML += `<div id="responseContainer">
          //           <h2>Ratings</h2>
          //               <h3>Total Holistic Score: ${totalScore}</h3>
          //               <h3>Content: <span>${contentScore}</span></h3>
          //               <pre>${contentRewrite}</pre>
          //               <pre>${contentComments}</pre>
          //               <h3>Organization: <span>${organizationScore}</span></h3>
          //               <pre>${organizationRewrite}</pre>
          //               <pre>${organizationComments}</pre>
          //               <h3>Grammar and Sentence Structure: <span>${grammarScore}</span></h3>
          //               <pre>${grammarRewrite}</pre>
          //               <pre>${grammarComments}</pre>
          //               <h3>Vocabulary and Spelling: <span>${vocabularyScore}</span></h3>
          //               <pre>${vocabularyRewrite}</pre>
          //               <pre>${vocabularyComments}</pre>
          //       </div>`;
          // } else {
          //   chatHistory.innerHTML += `<div style="color: green;">Response: ${JSON.stringify(jsonResponse)}</div>`;
          // }
          // chatHistory.innerHTML += `<div style="color: green;">Response: ${JSON.stringify(jsonResponse)}</div>`;

          // } catch (e) {
          //   console.log(e);
          //   // 如果jsonString不能解析为JSON，直接显示原始字符串
          //   chatHistory.innerHTML += `<div style="color: red;">${jsonString}</div>`;
          // }

      })
      .catch(error => {
          console.error('Error during fetch:', error);
          chatHistory.innerHTML += `<div style="color: red;">Error: ${error}</div>`;
      });

      // Simulate receiving a JSON response from your backend
      // var jsonResponse = {
      //     Ratings: {
      //         Content: {
      //             Score: 4.5,
      //             Rewrite: "In this day and age, social media has taken the world by storm, making emojis an indispensable part of our daily lives.",
      //             Comments: "The essay presents a clear argument about the importance of emojis in today's society and provides reasons to support it. However, the argument could be more nuanced and detailed.",
      //         },
      //         Organization: {
      //             Score: 4,
      //             Rewrite: "Furthermore, emojis may seem flawless when used for communication, but they can actually lead to misunderstandings and confusion.",
      //             Comments: "The essay follows a logical structure and connects paragraphs well. However, the introduction and conclusion could be stronger and more impactful.",
      //         },
      //         "Grammar and Sentence Structure": {
      //             Score: 4,
      //             Rewrite: "I had a relevant experience in the past when I participated in a speech contest and achieved a good grade after months of hard work and training.",
      //             Comments: "The essay demonstrates a good range of sentence structures, but there are some minor grammatical errors and awkward phrasings.",
      //         },
      //         "Vocabulary and Spelling": {
      //             Score: 4.5,
      //             Rewrite: "Last but not least, it is essential that we should think twice before sending them and ensure that the facial expression can match our messages perfectly.",
      //             Comments: "The essay uses vocabulary effectively and shows good spelling overall, but there are a few minor errors.",
      //         },
      //     },
      //     "Total Holistic Score": 17,
      // };

      
      // 滚动到聊天窗口底部
      chatHistory.scrollTop = chatHistory.scrollHeight;

      // 清空用户输入
      document.getElementById(`user-input-${windowId.split('-')[2]}`).value = '';
    }
  </script>
</body>
</html>
